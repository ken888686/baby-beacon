generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// 1. 使用者 (Parents/Caregivers)
model User {
  id    String  @id @default(uuid())
  email String  @unique
  name  String?
  image String?

  babies UserBaby[] // 多對多關聯：使用者管理的寶寶們

  emailVerified Boolean   @default(false)
  sessions      Session[]
  accounts      Account[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// Better Auth
model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([token])
  @@index([userId])
  @@map("session")
}

// Better Auth
model Account {
  id                    String    @id
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("account")
}

// Better Auth
model Verification {
  id         String @id
  identifier String
  value      String

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// 1.5 使用者與寶寶的關聯 (Join Table)
model UserBaby {
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  babyId String
  baby   Baby   @relation(fields: [babyId], references: [id], onDelete: Cascade)

  role BabyRole @default(OWNER) // 權限角色

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, babyId])
  @@map("users_babies")
}

// 2. 寶寶
model Baby {
  id        String   @id @default(uuid())
  name      String
  birthDate DateTime
  gender    Gender
  photoUrl  String?

  // 關聯
  users UserBaby[] // 多對多關聯：照顧這個寶寶的使用者們

  // 各類記錄關聯
  growthRecords GrowthRecord[]
  healthLogs    HealthLog[]
  sleepLogs     SleepLog[]
  feedLogs      FeedLog[]
  diaperLogs    DiaperLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("babies")
}

// 3. 生長曲線 (身高/體重/頭圍)
model GrowthRecord {
  id     String @id @default(uuid())
  babyId String
  baby   Baby   @relation(fields: [babyId], references: [id], onDelete: Cascade)

  height            Float? // cm
  weight            Float? // kg
  headCircumference Float? // cm

  recordedAt DateTime @default(now())
  recordedBy String
  note       String?

  // 索引優化：快速查詢特定寶寶的生長歷史
  @@index([babyId, recordedAt(sort: Desc)])
  @@map("growth_records")
}

// 4. 健康紀錄 (體溫/疫苗/用藥/症狀)
model HealthLog {
  id     String @id @default(uuid())
  babyId String
  baby   Baby   @relation(fields: [babyId], references: [id], onDelete: Cascade)

  type        HealthType // VACCINE, MEDICINE, TEMPERATURE, SYMPTOM
  value       Float? // 數值 (例如體溫 37.5)
  description String? // 描述 (例如 "卡介苗", "退燒藥")
  symptoms    String[] // 症狀標籤陣列

  recordedAt DateTime @default(now())
  recordedBy String
  note       String?

  @@index([babyId, recordedAt(sort: Desc)])
  @@map("health_logs")
}

// 5. 睡眠紀錄
model SleepLog {
  id     String @id @default(uuid())
  babyId String
  baby   Baby   @relation(fields: [babyId], references: [id], onDelete: Cascade)

  startTime DateTime
  endTime   DateTime? // null 代表「正在睡」

  quality String? // "Deep", "Restless", "Nap"

  createdAt  DateTime @default(now())
  recordedBy String? // User ID
  updatedAt  DateTime @updatedAt

  // 索引優化：查詢最近睡眠紀錄
  @@index([babyId, startTime(sort: Desc)])
  @@map("sleep_logs")
}

// 6. 飲食紀錄 (親餵/瓶餵/副食品)
model FeedLog {
  id     String @id @default(uuid())
  babyId String
  baby   Baby   @relation(fields: [babyId], references: [id], onDelete: Cascade)

  type FeedType // BREAST, BOTTLE_FORMULA, BOTTLE_BREAST_MILK, SOLID

  amount   Float? // ml (瓶餵/副食品用)
  duration Int? // 秒數 (親餵用)
  side     Side? // LEFT, RIGHT, BOTH (親餵用)

  recordedAt DateTime @default(now())
  recordedBy String
  note       String?

  @@index([babyId, recordedAt(sort: Desc)])
  @@map("feed_logs")
}

// 7. 尿布紀錄
model DiaperLog {
  id     String @id @default(uuid())
  babyId String
  baby   Baby   @relation(fields: [babyId], references: [id], onDelete: Cascade)

  type    DiaperType // WET, DIRTY, MIXED, DRY
  color   String? // 便便顏色
  texture String? // 便便形狀/質地

  recordedAt DateTime @default(now())
  recordedBy String
  note       String?

  @@index([babyId, recordedAt(sort: Desc)])
  @@map("diaper_logs")
}

// Enums

enum BabyRole {
  OWNER
  ADMIN
  VIEWER
}

enum Gender {
  MALE
  FEMALE
}

enum HealthType {
  TEMPERATURE
  SYMPTOM
  MEDICINE
  VACCINE
  OTHER
}

enum FeedType {
  BREAST
  BOTTLE_FORMULA
  BOTTLE_BREAST_MILK
  SOLID
}

enum Side {
  LEFT
  RIGHT
  BOTH
}

enum DiaperType {
  WET
  DIRTY
  MIXED
  DRY
}
